// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum City {
  Tripoli
  Benghazi
  Misrata
  Bayda
  Zawiya
  Khoms
  Tobruk
  Ajdabiya
  Sebha
  Sirte
  Derna
  Zliten
  Sabratha
  Ghat
  Jalu
}

enum ContractType {
  Subagent
  Merchant
  Both
}

enum BusinessType {
  Retail
  Wholesale
  FoodService
  Manufacturing
  Technology
  Healthcare
  FinancialServices
  RealEstate
  Education
  Transportation
  Entertainment
  NonProfit
}

enum TargetType {
  Team
  Salesman
}

enum Status {
  Pending
  Approved
  Declined
}

enum ReportType {
  Contract
  Compensation
}

enum UserRole {
  Admin
  SalesManager
  Salesman
}

model Team {
  id                 Int                  @id @default(autoincrement())
  name               String
  location           City
  managerId          Int?
  manager            User?                @relation("TeamManager", fields: [managerId], references: [id])
  salesmen           User[]
  targets            Target[] // Targets related to the team as a whole
  CompensationReport CompensationReport[]
}

model User {
  id                 Int                  @id @default(autoincrement())
  role               UserRole // "Admin", "SalesManager", "Salesman"
  username           String               @unique
  password           String
  name               String
  mobileNumber       String               @unique
  bcdAccount         String?
  evoAppId           String               @unique
  nationalId         String               @unique
  teamId             Int?
  team               Team?                @relation(fields: [teamId], references: [id])
  managedTeams       Team[]               @relation("TeamManager")
  contracts          Contract[]
  targets            Target[]
  CompensationReport CompensationReport[]
}

model Target {
  id                Int        @id @default(autoincrement())
  teamId            Int? // Foreign key for Team
  userId            Int? // Foreign key for User
  periodFrom        DateTime
  periodTo          DateTime
  targetType        TargetType // Enum to distinguish between 'Team' and 'Salesman'
  numberOfContracts Int
  totalAmountLYD    Float // For Team targets
  amountPerContract Float? // For Salesman targets
  bonusAmount       Float? // Bonus amount
  team              Team?      @relation(fields: [teamId], references: [id])
  individual        User?      @relation(fields: [userId], references: [id])
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
}

model Report {
  id                  Int                  @id @default(autoincrement())
  type                ReportType
  periodFrom          DateTime
  periodTo            DateTime
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  contractReports     ContractReport[]
  compensationReports CompensationReport[]
}

model Contract {
  id                        Int                @id @default(autoincrement())
  salesmanId                Int
  type                      ContractType
  companyName               String
  businessType              BusinessType
  ownerName                 String
  ownerMobileNumber         String
  companyMobileNumber       String
  contactPersonName         String
  contactPersonMobileNumber String
  bcdAccountNumber          String? // Optional
  branches                  Branch[]
  documents                 ContractDocument[] // Change from single document path to related documents
  status                    Status             @default(Pending) // "Pending", "Approved", "Declined"
  salesman                  User               @relation(fields: [salesmanId], references: [id])
  contractReports           ContractReport[]
  createdAt                 DateTime           @default(now())
  updatedAt                 DateTime           @updatedAt
}

model ContractDocument {
  id         Int      @id @default(autoincrement())
  contractId Int
  path       String
  contract   Contract @relation(fields: [contractId], references: [id])
}

model ContractReport {
  contractId Int
  reportId   Int
  pdfPath    String
  excelPath  String
  contract   Contract @relation(fields: [contractId], references: [id])
  report     Report   @relation(fields: [reportId], references: [id])

  @@id([contractId, reportId])
}

model CompensationReport {
  id          Int    @id @default(autoincrement())
  reportId    Int
  teamId      Int?
  salesmanId  Int?
  amountPaid  Float
  bonusAmount Float?
  pdfPath     String
  excelPath   String
  report      Report @relation(fields: [reportId], references: [id])
  team        Team?  @relation(fields: [teamId], references: [id])
  salesman    User?  @relation(fields: [salesmanId], references: [id])
}

model Branch {
  id         Int      @id @default(autoincrement())
  contractId Int
  name       String
  phone      String   @unique
  city       City
  locationX  Float
  locationY  Float
  contract   Contract @relation(fields: [contractId], references: [id])
}
